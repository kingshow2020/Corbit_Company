<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark" data-lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <main class="form-page">
        <div class="form-container">
            <h1 class="admin-title" data-ar="إدخال الإيرادات" data-en="Revenue Entry"></h1>
            <p class="admin-note" data-ar="أدخل إيرادات الشهر الماضي وستظهر في الداشبورد كالشهر الحالي" data-en="Enter last month's revenue — it will display as the current month"></p>

            <!-- Month Selector -->
            <div class="admin-section">
                <h2 class="section-label" data-ar="اختر الشهر" data-en="Select Month"></h2>
                <div class="month-selector" id="monthSelector"></div>
                <div class="input-row">
                    <input type="number" id="amountInput" placeholder="المبلغ" step="0.01" min="0">
                    <button class="btn btn-primary btn-sm" onclick="confirmEntry()">
                        <span data-ar="تأكيد" data-en="Confirm"></span>
                    </button>
                </div>
            </div>

            <!-- Divider -->
            <div class="admin-divider"></div>

            <!-- History -->
            <div class="admin-section">
                <h2 class="section-label" data-ar="سجل الإيرادات" data-en="Revenue History"></h2>
                <div class="months-list" id="monthsList"></div>
            </div>

            <!-- Status -->
            <div class="admin-status hidden" id="statusMsg"></div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        var monthNames = {
            ar: ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'],
            en: ['January','February','March','April','May','June','July','August','September','October','November','December']
        };

        var now = new Date();
        var currentYear = now.getFullYear();
        var selectedMonthKey = '';
        var allMonths = {};

        function getMonthLabel(key) {
            var parts = key.split('-');
            var y = parseInt(parts[0]);
            var m = parseInt(parts[1]) - 1;
            var lang = getLang();
            return monthNames[lang][m] + ' ' + y;
        }

        function buildMonthKey(year, month) {
            return year + '-' + String(month + 1).padStart(2, '0');
        }

        function buildMonthSelector() {
            var container = document.getElementById('monthSelector');
            var html = '';
            for (var m = 0; m < 12; m++) {
                var key = buildMonthKey(currentYear, m);
                var lang = getLang();
                var label = monthNames[lang][m];
                var hasData = allMonths[key] && allMonths[key] > 0;
                var isSelected = key === selectedMonthKey;
                html += '<button class="month-chip' +
                    (isSelected ? ' selected' : '') +
                    (hasData ? ' has-data' : '') +
                    '" onclick="selectMonth(\'' + key + '\')">' +
                    label +
                    (hasData ? ' ✓' : '') +
                    '</button>';
            }
            container.innerHTML = '<div class="year-label">' + currentYear + '</div>' +
                '<div class="month-chips">' + html + '</div>' +
                '<div class="year-nav">' +
                    '<button class="btn-nav" onclick="changeYear(-1)">◄ ' + (currentYear - 1) + '</button>' +
                    '<button class="btn-nav" onclick="changeYear(1)">' + (currentYear + 1) + ' ►</button>' +
                '</div>';
        }

        function selectMonth(key) {
            selectedMonthKey = key;
            var input = document.getElementById('amountInput');
            if (allMonths[key] && allMonths[key] > 0) {
                input.value = allMonths[key];
            } else {
                input.value = '';
            }
            buildMonthSelector();
            input.focus();
        }

        function changeYear(delta) {
            currentYear += delta;
            selectedMonthKey = '';
            buildMonthSelector();
        }

        function confirmEntry() {
            if (!selectedMonthKey) {
                var lang = getLang();
                showStatus(lang === 'ar' ? 'اختر شهر أولاً' : 'Select a month first', true);
                return;
            }

            var input = document.getElementById('amountInput');
            var amount = parseFloat(input.value);
            if (isNaN(amount) || amount < 0) return;

            var lang = getLang();
            var msg = (lang === 'ar' ? 'تأكيد إيرادات ' : 'Confirm revenue for ') +
                getMonthLabel(selectedMonthKey) + '\n' +
                formatNumber(amount) + (lang === 'ar' ? ' ريال' : ' SAR');

            if (!confirm(msg)) return;

            fetch(API_BASE + '/api/set-revenue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ monthKey: selectedMonthKey, amount: amount })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    allMonths = data.months || {};
                    buildMonthSelector();
                    renderHistory();
                    showStatus(lang === 'ar' ? 'تم الحفظ بنجاح' : 'Saved successfully', false);
                } else {
                    showStatus(lang === 'ar' ? 'خطأ في الحفظ' : 'Save error', true);
                }
            })
            .catch(function(err) {
                showStatus(lang === 'ar' ? 'خطأ في الاتصال' : 'Connection error', true);
                console.error(err);
            });
        }

        function renderHistory() {
            var container = document.getElementById('monthsList');
            var keys = Object.keys(allMonths).sort().reverse();

            if (keys.length === 0) {
                var lang = getLang();
                container.innerHTML = '<p class="empty-msg">' +
                    (lang === 'ar' ? 'لا توجد بيانات' : 'No data') + '</p>';
                return;
            }

            var total = 0;
            var html = keys.map(function(key) {
                var amount = allMonths[key];
                total += amount;
                return '<div class="history-row" onclick="selectMonth(\'' + key + '\')">' +
                    '<span class="history-month">' + getMonthLabel(key) + '</span>' +
                    '<span class="history-amount">' + formatNumber(amount) + ' SAR</span>' +
                '</div>';
            }).join('');

            html = '<div class="history-total">' +
                '<span>' + (getLang() === 'ar' ? 'الإجمالي' : 'Total') + '</span>' +
                '<span>' + formatNumber(total) + ' SAR</span>' +
            '</div>' + html;

            container.innerHTML = html;
        }

        function showStatus(msg, isError) {
            var el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'admin-status ' + (isError ? 'status-error' : 'status-success');
            el.classList.remove('hidden');
            setTimeout(function() { el.classList.add('hidden'); }, 3000);
        }

        document.getElementById('amountInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); confirmEntry(); }
        });

        // Load data
        fetch(API_BASE + '/api/get-revenue')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                allMonths = data.months || {};
                buildMonthSelector();
                renderHistory();
            })
            .catch(function(err) {
                showStatus('خطأ في تحميل البيانات', true);
                console.error(err);
            });

        buildMonthSelector();
        applyLang(getLang());
    </script>
</body>
</html>
