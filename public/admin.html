<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark" data-lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <main class="form-page">
        <div class="form-container">
            <h1 class="admin-title" data-ar="لوحة الإدارة" data-en="Admin Panel"></h1>

            <!-- Tab Switcher -->
            <div class="admin-tabs">
                <button class="admin-tab active" id="tabRevenue" onclick="switchTab('revenue')">
                    <span data-ar="الإيرادات" data-en="Revenue"></span>
                </button>
                <button class="admin-tab" id="tabExpenses" onclick="switchTab('expenses')">
                    <span data-ar="المصروفات" data-en="Expenses"></span>
                </button>
            </div>

            <!-- Month Selector -->
            <div class="admin-section">
                <h2 class="section-label" data-ar="اختر الشهر" data-en="Select Month"></h2>
                <div class="month-selector" id="monthSelector"></div>
                <div class="input-row">
                    <input type="number" id="amountInput" placeholder="المبلغ" step="0.01" min="0">
                    <button class="btn btn-primary btn-sm" onclick="confirmEntry()">
                        <span data-ar="تأكيد" data-en="Confirm"></span>
                    </button>
                </div>
            </div>

            <!-- Divider -->
            <div class="admin-divider"></div>

            <!-- History -->
            <div class="admin-section">
                <h2 class="section-label" id="historyLabel" data-ar="سجل الإيرادات" data-en="Revenue History"></h2>
                <div class="months-list" id="monthsList"></div>
            </div>

            <!-- Status -->
            <div class="admin-status hidden" id="statusMsg"></div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        var monthNames = {
            ar: ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'],
            en: ['January','February','March','April','May','June','July','August','September','October','November','December']
        };

        var now = new Date();
        var currentYear = now.getFullYear();
        var selectedMonthKey = '';
        var activeTab = 'revenue'; // 'revenue' or 'expenses'
        var allRevenue = {};
        var allExpenses = {};

        function getMonthLabel(key) {
            var parts = key.split('-');
            var y = parseInt(parts[0]);
            var m = parseInt(parts[1]) - 1;
            var lang = getLang();
            return monthNames[lang][m] + ' ' + y;
        }

        function buildMonthKey(year, month) {
            return year + '-' + String(month + 1).padStart(2, '0');
        }

        function getActiveData() {
            return activeTab === 'revenue' ? allRevenue : allExpenses;
        }

        function switchTab(tab) {
            activeTab = tab;
            document.getElementById('tabRevenue').classList.toggle('active', tab === 'revenue');
            document.getElementById('tabExpenses').classList.toggle('active', tab === 'expenses');

            var lang = getLang();
            var label = document.getElementById('historyLabel');
            if (tab === 'revenue') {
                label.setAttribute('data-ar', 'سجل الإيرادات');
                label.setAttribute('data-en', 'Revenue History');
                label.textContent = lang === 'ar' ? 'سجل الإيرادات' : 'Revenue History';
            } else {
                label.setAttribute('data-ar', 'سجل المصروفات');
                label.setAttribute('data-en', 'Expenses History');
                label.textContent = lang === 'ar' ? 'سجل المصروفات' : 'Expenses History';
            }

            selectedMonthKey = '';
            document.getElementById('amountInput').value = '';
            buildMonthSelector();
            renderHistory();
        }

        function buildMonthSelector() {
            var container = document.getElementById('monthSelector');
            var data = getActiveData();
            var html = '';
            for (var m = 0; m < 12; m++) {
                var key = buildMonthKey(currentYear, m);
                var lang = getLang();
                var label = monthNames[lang][m];
                var hasData = data[key] && data[key] > 0;
                var isSelected = key === selectedMonthKey;
                html += '<button class="month-chip' +
                    (isSelected ? ' selected' : '') +
                    (hasData ? (activeTab === 'revenue' ? ' has-data' : ' has-data-exp') : '') +
                    '" onclick="selectMonth(\'' + key + '\')">' +
                    label +
                    (hasData ? ' ✓' : '') +
                    '</button>';
            }
            container.innerHTML = '<div class="year-label">' + currentYear + '</div>' +
                '<div class="month-chips">' + html + '</div>' +
                '<div class="year-nav">' +
                    '<button class="btn-nav" onclick="changeYear(-1)">◄ ' + (currentYear - 1) + '</button>' +
                    '<button class="btn-nav" onclick="changeYear(1)">' + (currentYear + 1) + ' ►</button>' +
                '</div>';
        }

        function selectMonth(key) {
            selectedMonthKey = key;
            var data = getActiveData();
            var input = document.getElementById('amountInput');
            if (data[key] && data[key] > 0) {
                input.value = data[key];
            } else {
                input.value = '';
            }
            buildMonthSelector();
            input.focus();
        }

        function changeYear(delta) {
            currentYear += delta;
            selectedMonthKey = '';
            buildMonthSelector();
        }

        function confirmEntry() {
            if (!selectedMonthKey) {
                var lang = getLang();
                showStatus(lang === 'ar' ? 'اختر شهر أولاً' : 'Select a month first', true);
                return;
            }

            var input = document.getElementById('amountInput');
            var amount = parseFloat(input.value);
            if (isNaN(amount) || amount < 0) return;

            var lang = getLang();
            var typeName = activeTab === 'revenue'
                ? (lang === 'ar' ? 'إيرادات ' : 'Revenue for ')
                : (lang === 'ar' ? 'مصروفات ' : 'Expenses for ');
            var msg = typeName + getMonthLabel(selectedMonthKey) + '\n' + formatNumber(amount) + (lang === 'ar' ? ' ريال' : ' SAR');

            if (!confirm(msg)) return;

            fetch(API_BASE + '/api/set-revenue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: activeTab, monthKey: selectedMonthKey, amount: amount })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    allRevenue = data.revenue || {};
                    allExpenses = data.expenses || {};
                    buildMonthSelector();
                    renderHistory();
                    showStatus(lang === 'ar' ? 'تم الحفظ بنجاح' : 'Saved successfully', false);
                } else {
                    showStatus(lang === 'ar' ? 'خطأ في الحفظ' : 'Save error', true);
                }
            })
            .catch(function(err) {
                showStatus(lang === 'ar' ? 'خطأ في الاتصال' : 'Connection error', true);
                console.error(err);
            });
        }

        function renderHistory() {
            var container = document.getElementById('monthsList');
            var data = getActiveData();
            var keys = Object.keys(data).sort().reverse();

            if (keys.length === 0) {
                var lang = getLang();
                container.innerHTML = '<p class="empty-msg">' +
                    (lang === 'ar' ? 'لا توجد بيانات' : 'No data') + '</p>';
                return;
            }

            var total = 0;
            var html = keys.map(function(key) {
                var amount = data[key];
                total += amount;
                return '<div class="history-row" onclick="selectMonth(\'' + key + '\')">' +
                    '<span class="history-month">' + getMonthLabel(key) + '</span>' +
                    '<span class="history-amount">' + formatNumber(amount) + ' SAR</span>' +
                '</div>';
            }).join('');

            var isExp = activeTab === 'expenses';
            html = '<div class="history-total' + (isExp ? ' history-total-exp' : '') + '">' +
                '<span>' + (getLang() === 'ar' ? 'الإجمالي' : 'Total') + '</span>' +
                '<span>' + formatNumber(total) + ' SAR</span>' +
            '</div>' + html;

            container.innerHTML = html;
        }

        function showStatus(msg, isError) {
            var el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'admin-status ' + (isError ? 'status-error' : 'status-success');
            el.classList.remove('hidden');
            setTimeout(function() { el.classList.add('hidden'); }, 3000);
        }

        document.getElementById('amountInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); confirmEntry(); }
        });

        // Load data
        fetch(API_BASE + '/api/get-revenue')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                allRevenue = data.revenue || {};
                allExpenses = data.expenses || {};
                buildMonthSelector();
                renderHistory();
            })
            .catch(function(err) {
                showStatus('خطأ في تحميل البيانات', true);
                console.error(err);
            });

        buildMonthSelector();
        applyLang(getLang());
    </script>
</body>
</html>
