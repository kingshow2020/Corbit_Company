<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark" data-lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <main class="form-page">
        <div class="form-container">
            <h1 class="admin-title" data-ar="إدخال الإيرادات اليومية" data-en="Daily Revenue Entry"></h1>
            <p class="admin-note" data-ar="أدخل إيرادات اليوم وستظهر في الداشبورد تلقائياً" data-en="Enter today's revenue and it will appear on the dashboard automatically"></p>

            <!-- Alert for missing days -->
            <div class="daily-alert hidden" id="missingAlert">
                <div class="alert-icon">!</div>
                <span id="missingText"></span>
            </div>

            <!-- All complete message -->
            <div class="daily-complete hidden" id="completeMsg">
                <span data-ar="كل الأيام مكتملة" data-en="All days are complete"></span>
            </div>

            <!-- Date display -->
            <div class="daily-date" id="targetDate"></div>

            <!-- Input -->
            <div class="admin-section">
                <div class="input-row">
                    <input type="number" id="amountInput" placeholder="المبلغ" step="0.01" min="0">
                    <button class="btn btn-primary btn-sm" id="submitBtn" onclick="submitDaily()">
                        <span data-ar="إضافة" data-en="Add"></span>
                    </button>
                </div>
            </div>

            <!-- Divider -->
            <div class="admin-divider"></div>

            <!-- History -->
            <div class="admin-section">
                <h2 class="section-label" data-ar="سجل آخر 30 يوم" data-en="Last 30 Days"></h2>
                <div class="months-list" id="daysList"></div>
            </div>

            <!-- Status -->
            <div class="admin-status hidden" id="statusMsg"></div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        var allDays = {};
        var targetDateKey = ''; // The date we're currently adding for

        var dayNames = {
            ar: ['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'],
            en: ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']
        };
        var monthNames = {
            ar: ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'],
            en: ['January','February','March','April','May','June','July','August','September','October','November','December']
        };

        // Get Saudi time (UTC+3)
        function getSaudiNow() {
            var utcNow = new Date();
            return new Date(utcNow.getTime() + (3 * 60 * 60 * 1000));
        }

        function dateKeyToDate(key) {
            var parts = key.split('-');
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }

        function formatDateKey(d) {
            return d.getFullYear() + '-' +
                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                String(d.getDate()).padStart(2, '0');
        }

        function getYesterdayKey() {
            var now = getSaudiNow();
            var yesterday = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 1));
            return yesterday.getUTCFullYear() + '-' +
                String(yesterday.getUTCMonth() + 1).padStart(2, '0') + '-' +
                String(yesterday.getUTCDate()).padStart(2, '0');
        }

        function formatDateLabel(key) {
            var parts = key.split('-');
            var d = parseInt(parts[2]);
            var m = parseInt(parts[1]) - 1;
            var y = parseInt(parts[0]);
            var lang = getLang();
            var dt = new Date(y, m, d);
            var dayName = dayNames[lang][dt.getDay()];
            return d + ' ' + monthNames[lang][m] + ' ' + y + ' (' + dayName + ')';
        }

        function formatDateShort(key) {
            var parts = key.split('-');
            var d = parseInt(parts[2]);
            var m = parseInt(parts[1]) - 1;
            var lang = getLang();
            return d + ' ' + monthNames[lang][m];
        }

        // Find the oldest missing day (from yesterday going back, within current month)
        function findMissingDay() {
            var now = getSaudiNow();
            var year = now.getUTCFullYear();
            var month = now.getUTCMonth();

            // Start from yesterday, go back to 1st of current month
            var yesterday = new Date(Date.UTC(year, month, now.getUTCDate() - 1));
            var firstOfMonth = new Date(Date.UTC(year, month, 1));

            // Collect all missing days
            var missing = [];
            var check = new Date(yesterday);
            while (check >= firstOfMonth) {
                var key = check.getUTCFullYear() + '-' +
                    String(check.getUTCMonth() + 1).padStart(2, '0') + '-' +
                    String(check.getUTCDate()).padStart(2, '0');
                if (!allDays[key] || allDays[key] <= 0) {
                    missing.push(key);
                }
                check.setUTCDate(check.getUTCDate() - 1);
            }

            // Return the oldest missing day (so they fill in chronological order)
            if (missing.length > 0) {
                return missing[missing.length - 1];
            }
            return null;
        }

        function updateUI() {
            var lang = getLang();
            var missingDay = findMissingDay();
            var alertEl = document.getElementById('missingAlert');
            var completeEl = document.getElementById('completeMsg');
            var dateEl = document.getElementById('targetDate');
            var input = document.getElementById('amountInput');
            var submitBtn = document.getElementById('submitBtn');

            if (missingDay) {
                // There's a missing day
                targetDateKey = missingDay;
                alertEl.classList.remove('hidden');
                completeEl.classList.add('hidden');

                var missingLabel = formatDateShort(missingDay);
                document.getElementById('missingText').textContent =
                    lang === 'ar'
                        ? 'يوم ' + missingLabel + ' ما أُضيفت بعد!'
                        : missingLabel + ' not entered yet!';

                dateEl.textContent = formatDateLabel(missingDay);

                submitBtn.querySelector('span').textContent =
                    lang === 'ar'
                        ? 'إضافة إيرادات ' + missingLabel
                        : 'Add revenue for ' + missingLabel;

                // Pre-fill if exists
                if (allDays[missingDay]) {
                    input.value = allDays[missingDay];
                } else {
                    input.value = '';
                }
                input.disabled = false;
                submitBtn.disabled = false;
            } else {
                // All days complete — default to yesterday
                var yesterdayKey = getYesterdayKey();
                targetDateKey = yesterdayKey;
                alertEl.classList.add('hidden');

                // Check if yesterday is entered
                if (allDays[yesterdayKey]) {
                    completeEl.classList.remove('hidden');
                    dateEl.textContent = formatDateLabel(yesterdayKey);
                    input.value = allDays[yesterdayKey];
                    submitBtn.querySelector('span').textContent =
                        lang === 'ar' ? 'تعديل' : 'Update';
                } else {
                    completeEl.classList.add('hidden');
                    dateEl.textContent = formatDateLabel(yesterdayKey);
                    input.value = '';
                    submitBtn.querySelector('span').textContent =
                        lang === 'ar'
                            ? 'إضافة إيرادات ' + formatDateShort(yesterdayKey)
                            : 'Add revenue for ' + formatDateShort(yesterdayKey);
                }
                input.disabled = false;
                submitBtn.disabled = false;
            }

            renderHistory();
            applyLang(lang);
        }

        function submitDaily() {
            if (!targetDateKey) return;

            var input = document.getElementById('amountInput');
            var amount = parseFloat(input.value);
            if (isNaN(amount) || amount < 0) {
                showStatus(getLang() === 'ar' ? 'أدخل مبلغ صحيح' : 'Enter valid amount', true);
                return;
            }

            var lang = getLang();

            fetch(API_BASE + '/api/set-daily', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: targetDateKey, amount: amount })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    allDays = data.days || {};
                    input.value = '';
                    showStatus(
                        lang === 'ar'
                            ? 'تم حفظ إيرادات ' + formatDateShort(data.date)
                            : 'Saved revenue for ' + formatDateShort(data.date),
                        false
                    );
                    updateUI(); // Re-check for next missing day
                } else {
                    showStatus(
                        lang === 'ar' ? 'خطأ: ' + (data.error || 'خطأ في الحفظ')
                            : 'Error: ' + (data.error || 'Save error'),
                        true
                    );
                }
            })
            .catch(function(err) {
                showStatus(lang === 'ar' ? 'خطأ في الاتصال' : 'Connection error', true);
                console.error(err);
            });
        }

        function renderHistory() {
            var container = document.getElementById('daysList');
            if (!container) return;

            var lang = getLang();
            var now = getSaudiNow();
            var year = now.getUTCFullYear();
            var month = now.getUTCMonth();

            // Build list of last 30 days (from yesterday back)
            var days = [];
            var monthTotal = 0;
            var currentMonthPrefix = year + '-' + String(month + 1).padStart(2, '0');

            for (var i = 1; i <= 30; i++) {
                var d = new Date(Date.UTC(year, month, now.getUTCDate() - i));
                var key = d.getUTCFullYear() + '-' +
                    String(d.getUTCMonth() + 1).padStart(2, '0') + '-' +
                    String(d.getUTCDate()).padStart(2, '0');
                var amount = allDays[key] || 0;
                var hasData = amount > 0;
                var isCurrentMonth = key.startsWith(currentMonthPrefix);

                if (isCurrentMonth && hasData) {
                    monthTotal += amount;
                }

                days.push({ key: key, amount: amount, hasData: hasData, isCurrentMonth: isCurrentMonth });
            }

            if (days.length === 0) {
                container.innerHTML = '<p class="empty-msg">' +
                    (lang === 'ar' ? 'لا توجد بيانات' : 'No data') + '</p>';
                return;
            }

            // Month total header
            var html = '<div class="history-total">' +
                '<span>' + (lang === 'ar' ? 'إجمالي الشهر' : 'Month Total') + '</span>' +
                '<span>' + formatNumber(monthTotal) + ' SAR</span>' +
            '</div>';

            html += days.map(function(day) {
                var statusIcon = day.hasData ? '<span class="day-check">&#10003;</span>' : '<span class="day-miss">&#10007;</span>';
                var amountText = day.hasData ? formatNumber(day.amount) + ' SAR' : (lang === 'ar' ? '—' : '—');
                var rowClass = 'history-row' + (day.hasData ? '' : ' missing-row');

                return '<div class="' + rowClass + '" onclick="selectDay(\'' + day.key + '\')">' +
                    '<span class="history-month">' + statusIcon + ' ' + formatDateShort(day.key) + '</span>' +
                    '<span class="history-amount">' + amountText + '</span>' +
                '</div>';
            }).join('');

            container.innerHTML = html;
        }

        function selectDay(key) {
            targetDateKey = key;
            var input = document.getElementById('amountInput');
            if (allDays[key] && allDays[key] > 0) {
                input.value = allDays[key];
            } else {
                input.value = '';
            }

            var lang = getLang();
            var label = formatDateShort(key);
            document.getElementById('targetDate').textContent = formatDateLabel(key);
            document.getElementById('submitBtn').querySelector('span').textContent =
                lang === 'ar'
                    ? (allDays[key] ? 'تعديل إيرادات ' : 'إضافة إيرادات ') + label
                    : (allDays[key] ? 'Update revenue for ' : 'Add revenue for ') + label;

            input.focus();
        }

        function showStatus(msg, isError) {
            var el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'admin-status ' + (isError ? 'status-error' : 'status-success');
            el.classList.remove('hidden');
            setTimeout(function() { el.classList.add('hidden'); }, 3000);
        }

        // Enter key
        document.getElementById('amountInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); submitDaily(); }
        });

        // Load data
        fetch(API_BASE + '/api/get-revenue')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                allDays = data.days || {};
                updateUI();
            })
            .catch(function(err) {
                showStatus('خطأ في تحميل البيانات', true);
                console.error(err);
            });

        applyLang(getLang());
    </script>
</body>
</html>
